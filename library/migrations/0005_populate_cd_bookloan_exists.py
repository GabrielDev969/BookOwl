# Generated by Django 5.2.4 on 2025-07-17 19:20

from django.db import migrations
from django.db.models import F

def populate_cd_bookloan(apps, schema_editor):
    BookLoan = apps.get_model('library', 'BookLoan')
    Library = apps.get_model('library', 'Library')
    
    print("Iniciando a população do campo 'cd_bookloan'...")
    
    for library in Library.objects.filter(bookloan__isnull=False).distinct():
        
        print(f"  -> Processando biblioteca: '{library.name}'")

        loans_from_library = BookLoan.objects.filter(library=library).order_by('loan_date', 'pk')

        for sequence, loan in enumerate(loans_from_library, start=1):
            loan.cd_bookloan = sequence
            loan.save(update_fields=['cd_bookloan'])

    print("  -> População de 'cd_bookloan' concluída.")

class Migration(migrations.Migration):

    dependencies = [
        ('library', '0004_alter_bookloan_options_bookloan_cd_bookloan_and_more'),
    ]

    operations = [
        migrations.RunPython(populate_cd_bookloan),
    ]
